# This thing handles the dude that sits at the entrance to the fire temple portal
# It was written by Wahrheit and you better believe it
# @author Wahrheit
# @version 2.0
# @last-updated December 27 2017

"Sage of Flame":
    type: assignment
    interact scripts:
    - 10 Fire Temple Challenger
    actions:
        on assignment:
        - run "script:Flame Gate" instant
"Sage Format":
    type: format
    format: "<red>Sage of Flame<white><&co> <text>"
"Flame Gate":
    type: task
    script:
    - teleport npc 'location:<anchor:ftsage>'
    - trigger name:proximity toggle:true radius:3
    - flag global firetempleclear:1
    - flag global firetemplechallenger:!
    - flag global firetemplechallenger-name:!
"Fire Temple Tracker":
    type: world
    events:
        on player dies:
        - if <player.location.world.name> == 'ultimatus' && <player.uuid> == <global.flag[firetemple-challenger]> {
          - flag global firetempleclear:1
          - announce "<red><player.name> has been conquered by the Fire Temple. It is now clear."
          - flag global firetemple-challenger:!
          - flag global firetemple-challenger-name:!
          }
        on player changes world from ultimatus:
        - if <player.location.world.name> != 'ultimatus' && <player.uuid> == <global.flag[firetemple-challenger]> {
          - flag global firetempleclear:1
          - announce "<red><player.name> has abandoned the Fire Temple. It is now clear."
          - flag global firetemple-challenger:!
          - flag global firetemple-challenger-name:!
          }
        on player quits:
        - if <player.uuid> == <global.flag[firetemple-challenger]> {
          - flag global firetempleclear:1
          - flag global firetemple-challenger:!
          - flag global firetemple-challenger-name:!
          - determine passive "<red><player.name> has vanished into the mists and abandoned the Fire Temple. It is now clear."         
          - flag global "firetemple-abandoner:->:<player.uuid>"
          }
        on player joins:
        - if <player.uuid> == <global.flag[firetemple-abandoner]> {
          - execute as_server "warp <player.name> spawn"
          - flag global "firetemple-abandoner:<-:<player.uuid>"
          - narrate "<red>You disconnected while in the Fire Temple and have been returned to spawn." 
          }
"FireTemple-Reset":
    type: task
    script:
    # Miniboss Gate / Bridge
    - switch state:off location:-4,74,1,ultimatus
    # Upstairs Bridges
    - switch state:off location:-1,74,1,ultimatus
    # West Stairs
    - switch state:off location:2,74,1,ultimatus
    # West Key
    - switch state:off location:-1,74,4,ultimatus
    # East Key
    - switch state:off location:1,74,4,ultimatus      
    # Spawns boss at entry point
    - execute as_server "npc spawn 88 --at 0,119,-30,ultimatus"
    - execute as_server "npc select 88"
    - execute as_server "npc anchor --assume 'ftboss1'"
    - execute as_server "npc spawn 87 --at 56,29,-26,ultimatus"
    - execute as_server "npc select 87"
    - execute as_server "npc anchor --assume 'ftminiboss'"
    - execute as_server "npc despawn 93"
    - zap "script:Great Balls of Fire" "step:Miniboss"
    - zap "script:Get Out My House" "step:Boss Battle"
    - zap "script:Flame Savior" "step:Before Fight"
    - zap "script:Player Approaches" "step:Entry"
    - remove <l@0,74,4,ultimatus.find.entities[wither].within[400]>
    
"Fire Temple Challenger":
    type: interact
    steps:
        'Greeting*':
            proximity trigger:
                entry:
                    radius: 3
                    script:
                    - narrate "format:Sage Format" "Hello, <player.name>. Welcome to the Altar of Flame."
                    - zap 'step:Entrance'
#            click trigger:
#                script:
#                - narrate "format:Sage Format" "You're at the step 'Greeting'! This is a debug message!"

        'Entrance':
            click trigger:
                script:
                - narrate "format:Sage Format" "The vile and wretched Lord Emfyrius has established a corrupted domain in an effort to challenge the God of Flame."
                - narrate "format:Sage Format" "We need a bold, powerful adventurer to challenge him and end his heresy. Are you up to the challenge?"
                - zap 'step:Verify'
            proximity trigger:
                exit:
                    radius: 3
                    script:
                    - zap 'step:Greeting'
        'Verify':
            click trigger:
                script:
                - if <global.flag[firetempleclear]> == 1 {
                  - narrate "format:Sage Format" "Very well. I wish you the very best of luck in your efforts."
                  - flag global firetempleclear:0
                  - flag global firetemple-challenger:<player.uuid>
                  - flag global firetemple.challenger-name:<player.name>
#                  - narrate "Flag firetemple-challenger is <global.flag[firetemple-challenger]>"
#                  - narrate "Flag firetemple-challenger-name is <global.flag[firetemple-challenger-name]>"
                  - narrate "<yellow>The Sage of Flame begins chanting a spell..."
                  - run "script:FireTemple-Reset"
                  - execute as_npc "warp <player.name> firetemple"
                  - announce "<red><player.name> is challenging the Fire Temple."}
                  else {
                  - narrate "format:Sage Format" "Sorry, it appears the temple is currently being challenged by <global.flag[firetemple-challenger-name]>. You will have to wait." }
            proximity trigger:
                exit:
                    radius: 3
                    script:
                    - zap 'step:Greeting'